<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Nomad</title>

    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Global Nomad">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js');
        });
      }
    </script>

    <style>
        body {
            margin: 0; padding: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: url('https://images.unsplash.com/photo-1488646953014-85cb44e25828?auto=format&fit=crop&w=1600&q=80') no-repeat center center fixed;
            background-size: cover;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; color: #333;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.3); z-index: 1;
        }
        .container {
            position: relative; z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px); padding: 1.5rem;
            border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 92%; max-width: 450px; text-align: center;
        }
        .lang-toggle {
            position: absolute; top: 15px; right: 20px;
            background: #eee; border: none; padding: 5px 12px;
            border-radius: 20px; font-size: 0.7rem; cursor: pointer; font-weight: bold;
        }
        .tabs { display: flex; margin-bottom: 1.5rem; border-bottom: 2px solid #eee; margin-top: 10px; }
        .tab { flex: 1; padding: 12px; cursor: pointer; color: #999; font-weight: bold; transition: 0.3s; }
        .tab.active { color: #007bff; border-bottom: 2px solid #007bff; }
        .content { display: none; }
        .content.active { display: block; }
        .input-group { margin-bottom: 1rem; text-align: left; }
        label { display: block; font-size: 0.75rem; color: #666; margin-bottom: 5px; font-weight: bold; }
        .search-input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px 10px 0 0; font-size: 0.9rem; box-sizing: border-box; background: #fafafa; outline: none; border-bottom: none; }
        select, input[type="number"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: white; -webkit-appearance: none; }
        .has-search select { border-radius: 0 0 10px 10px; border-top: 1px solid #eee; }
        button.main-btn { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .result-box { margin-top: 1.2rem; padding: 1.2rem; background: #f0f7ff; border-radius: 12px; font-size: 1.1rem; font-weight: bold; min-height: 50px; }
        #clockList { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 1rem; max-height: 250px; overflow-y: auto; padding: 5px; }
        .clock-card { background: #f8f9fa; padding: 12px; border-radius: 15px; border: 1px solid #eee; position: relative; text-align: left; }
        .clock-city { font-size: 0.9rem; font-weight: bold; }
        .clock-time { font-size: 1.2rem; font-weight: bold; color: #007bff; font-family: monospace; margin-top: 5px; }
        .remove-btn { background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; position: absolute; top: -8px; right: -8px; }
    </style>
</head>
<body>

<div class="container">
    <button class="lang-toggle" onclick="toggleLanguage()" id="langBtn">EN / JP</button>
    <div class="tabs">
        <div id="tab-curr" class="tab active" onclick="showTab('currency')" data-i18n="tab_curr">ÈÄöË≤®ÊèõÁÆó</div>
        <div id="tab-time" class="tab" onclick="showTab('time')" data-i18n="tab_time">‰∏ñÁïåÊôÇË®à</div>
    </div>

    <div id="currency" class="content active">
        <div class="input-group">
            <label data-i18n="label_amount">ÈáëÈ°ç</label>
            <input type="number" id="amount" value="10000">
        </div>
        <div class="input-group has-search">
            <label data-i18n="label_from">Â§âÊèõÂÖÉ</label>
            <input type="text" class="search-input" id="searchFrom" placeholder="Ê§úÁ¥¢..." oninput="updateSelectList('fromCurr', this.value)">
            <select id="fromCurr" size="5"></select>
        </div>
        <div class="input-group has-search">
            <label data-i18n="label_to">Â§âÊèõÂÖà</label>
            <input type="text" class="search-input" id="searchTo" placeholder="Ê§úÁ¥¢..." oninput="updateSelectList('toCurr', this.value)">
            <select id="toCurr" size="5"></select>
        </div>
        <button class="main-btn" onclick="calculateCurrency()" data-i18n="btn_convert">ÊèõÁÆó„Åô„Çã</button>
        <div class="result-box" id="currResult" data-i18n="res_init">ÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    </div>

    <div id="time" class="content">
        <div class="input-group has-search">
            <label data-i18n="label_add_city">ÈÉΩÂ∏Ç„ÇíËøΩÂä†</label>
            <input type="text" class="search-input" id="searchTime" placeholder="Ê§úÁ¥¢..." oninput="updateSelectList('timeSelect', this.value, true)">
            <select id="timeSelect" onchange="addClock()" size="5"></select>
        </div>
        <div id="clockList"></div>
    </div>
</div>

<script>
    const i18n = {
        ja: { tab_curr: "ÈÄöË≤®ÊèõÁÆó", tab_time: "‰∏ñÁïåÊôÇË®à", label_amount: "ÈáëÈ°ç", label_from: "Â§âÊèõÂÖÉ", label_to: "Â§âÊèõÂÖà", btn_convert: "ÊèõÁÆó„Åô„Çã", res_init: "ÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", label_add_city: "ÈÉΩÂ∏Ç„ÇíËøΩÂä†", opt_select_city: "-- ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ --", getting: "ÂèñÂæó‰∏≠...", err_api: "ÂèñÂæóÂ§±Êïó" },
        en: { tab_curr: "Currency", tab_time: "World Clock", label_amount: "Amount", label_from: "From", label_to: "To", btn_convert: "Convert", res_init: "Enter amount", label_add_city: "Add City", opt_select_city: "-- Select City --", getting: "Fetching...", err_api: "Error" }
    };

    let currentLang = 'ja';
    const locations = [
        { city: "Êù±‰∫¨", cityEn: "Tokyo", country: "Êó•Êú¨", countryEn: "Japan", code: "JPY", tz: "Asia/Tokyo" },
        { city: "„Éã„É•„Éº„É®„Éº„ÇØ", cityEn: "New York", country: "„Ç¢„É°„É™„Ç´", countryEn: "USA", code: "USD", tz: "America/New_York" },
        { city: "„É≠„É≥„Éâ„É≥", cityEn: "London", country: "„Ç§„ÇÆ„É™„Çπ", countryEn: "UK", code: "GBP", tz: "Europe/London" },
        { city: "„Éë„É™", cityEn: "Paris", country: "„Éï„É©„É≥„Çπ", countryEn: "France", code: "EUR", tz: "Europe/Paris" },
        { city: "„ÇΩ„Ç¶„É´", cityEn: "Seoul", country: "ÈüìÂõΩ", countryEn: "South Korea", code: "KRW", tz: "Asia/Seoul" },
        { city: "‰∏äÊµ∑", cityEn: "Shanghai", country: "‰∏≠ÂõΩ", countryEn: "China", code: "CNY", tz: "Asia/Shanghai" },
        { city: "„Ç∑„É≥„Ç¨„Éù„Éº„É´", cityEn: "Singapore", country: "„Ç∑„É≥„Ç¨„Éù„Éº„É´", countryEn: "Singapore", code: "SGD", tz: "Asia/Singapore" },
        { city: "Âè∞Âåó", cityEn: "Taipei", country: "Âè∞Êπæ", countryEn: "Taiwan", code: "TWD", tz: "Asia/Taipei" },
        { city: "È¶ôÊ∏Ø", cityEn: "Hong Kong", country: "È¶ôÊ∏Ø", countryEn: "Hong Kong", code: "HKD", tz: "Asia/Hong_Kong" },
        { city: "„Éê„É≥„Ç≥„ÇØ", cityEn: "Bangkok", country: "„Çø„Ç§", countryEn: "Thailand", code: "THB", tz: "Asia/Bangkok" },
        { city: "„Ç∑„Éâ„Éã„Éº", cityEn: "Sydney", country: "Ë±™Â∑û", countryEn: "Australia", code: "AUD", tz: "Australia/Sydney" },
        { city: "„Éâ„Éê„Ç§", cityEn: "Dubai", country: "UAE", countryEn: "UAE", code: "AED", tz: "Asia/Dubai" },
        { city: "„É≠„Çµ„É≥„Çº„É´„Çπ", cityEn: "Los Angeles", country: "„Ç¢„É°„É™„Ç´", countryEn: "USA", code: "USD", tz: "America/Los_Angeles" },
        { city: "„Éà„É≠„É≥„Éà", cityEn: "Toronto", country: "„Ç´„Éä„ÉÄ", countryEn: "Canada", code: "CAD", tz: "America/Toronto" },
        { city: "„Éô„É´„É™„É≥", cityEn: "Berlin", country: "„Éâ„Ç§„ÉÑ", countryEn: "Germany", code: "EUR", tz: "Europe/Berlin" },
        { city: "„É≠„Éº„Éû", cityEn: "Rome", country: "„Ç§„Çø„É™„Ç¢", countryEn: "Italy", code: "EUR", tz: "Europe/Rome" },
        { city: "„Éû„Éâ„É™„Éº„Éâ", cityEn: "Madrid", country: "„Çπ„Éö„Ç§„É≥", countryEn: "Spain", code: "EUR", tz: "Europe/Madrid" },
        { city: "„ÉÅ„É•„Éº„É™„ÉÉ„Éí", cityEn: "Zurich", country: "„Çπ„Ç§„Çπ", countryEn: "Switzerland", code: "CHF", tz: "Europe/Zurich" },
        { city: "„Ç§„Çπ„Çø„É≥„Éñ„Éº„É´", cityEn: "Istanbul", country: "„Éà„É´„Ç≥", countryEn: "Turkey", code: "TRY", tz: "Europe/Istanbul" },
        { city: "„É†„É≥„Éê„Ç§", cityEn: "Mumbai", country: "„Ç§„É≥„Éâ", countryEn: "India", code: "INR", tz: "Asia/Kolkata" },
        { city: "„Çµ„É≥„Éë„Ç¶„É≠", cityEn: "Sao Paulo", country: "„Éñ„É©„Ç∏„É´", countryEn: "Brazil", code: "BRL", tz: "America/Sao_Paulo" },
        { city: "„Ç´„Ç§„É≠", cityEn: "Cairo", country: "„Ç®„Ç∏„Éó„Éà", countryEn: "Egypt", code: "EGP", tz: "Africa/Cairo" },
        { city: "„Ç™„Éº„ÇØ„É©„É≥„Éâ", cityEn: "Auckland", country: "NZ", countryEn: "New Zealand", code: "NZD", tz: "Pacific/Auckland" },
        { city: "„ÉÜ„É´„Ç¢„Éì„Éñ", cityEn: "Tel Aviv", country: "„Ç§„Çπ„É©„Ç®„É´", countryEn: "Israel", code: "ILS", tz: "Asia/Jerusalem" },
        { city: "„É°„Ç≠„Ç∑„Ç≥„Ç∑„ÉÜ„Ç£", cityEn: "Mexico City", country: "„É°„Ç≠„Ç∑„Ç≥", countryEn: "Mexico", code: "MXN", tz: "America/Mexico_City" },
        { city: "„Éõ„Éº„ÉÅ„Éü„É≥", cityEn: "Ho Chi Minh", country: "„Éô„Éà„Éä„É†", countryEn: "Vietnam", code: "VND", tz: "Asia/Ho_Chi_Minh" },
        { city: "„Éê„É≥„ÇØ„Éº„Éê„Éº", cityEn: "Vancouver", country: "„Ç´„Éä„ÉÄ", countryEn: "Canada", code: "CAD", tz: "America/Vancouver" },
        { city: "„ÇØ„Ç¢„É©„É´„É≥„Éó„Éº„É´", cityEn: "K.L.", country: "„Éû„É¨„Éº„Ç∑„Ç¢", countryEn: "Malaysia", code: "MYR", tz: "Asia/Kuala_Lumpur" },
        { city: "„Ç∏„É£„Ç´„É´„Çø", cityEn: "Jakarta", country: "„Ç§„É≥„Éâ„Éç„Ç∑„Ç¢", countryEn: "Indonesia", code: "IDR", tz: "Asia/Jakarta" },
        { city: "„Éû„Éã„É©", cityEn: "Manila", country: "„Éï„Ç£„É™„Éî„É≥", countryEn: "Philippines", code: "PHP", tz: "Asia/Manila" }
    ];

    let pinnedCities = ["Asia/Tokyo", "America/New_York", "Europe/London"];

    function init() { 
        updateUI(); 
        setInterval(updateClocks, 1000); 
    }

    function toggleLanguage() { 
        currentLang = currentLang === 'ja' ? 'en' : 'ja'; 
        updateUI(); 
    }
    
    function updateUI() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            el.innerText = i18n[currentLang][el.getAttribute('data-i18n')];
        });
        updateSelectList('fromCurr', '');
        updateSelectList('toCurr', '');
        updateSelectList('timeSelect', '', true);
        renderClocks();
    }

    // üåü ‰øÆÊ≠£„ÅÆË¶ÅÔºö„É™„Çπ„Éà„ÇíÂãïÁöÑ„Å´Êõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
    function updateSelectList(selectId, query, isTime = false) {
        const select = document.getElementById(selectId);
        const currentValue = select.value;
        select.innerHTML = isTime ? `<option value="">${i18n[currentLang].opt_select_city}</option>` : "";
        
        locations.filter(l => {
            const text = (currentLang === 'ja' ? l.city + l.country : l.cityEn + l.countryEn).toLowerCase();
            return text.includes(query.toLowerCase()) || l.code.toLowerCase().includes(query.toLowerCase());
        }).forEach(l => {
            const label = isTime ? 
                (currentLang === 'ja' ? `${l.city} (${l.country})` : `${l.cityEn} (${l.countryEn})`) :
                (currentLang === 'ja' ? `${l.country} (${l.code})` : `${l.countryEn} (${l.code})`);
            const val = isTime ? l.tz : l.code;
            select.add(new Option(label, val));
        });
        if (!isTime) select.value = currentValue || (selectId === 'fromCurr' ? 'JPY' : 'USD');
    }

    async function calculateCurrency() {
        const amt = document.getElementById('amount').value, from = document.getElementById('fromCurr').value, to = document.getElementById('toCurr').value, resBox = document.getElementById('currResult');
        resBox.innerText = i18n[currentLang].getting;
        try {
            const response = await fetch(`/api/convert?from=${from}&to=${to}&amount=${amt}`);
            const data = await response.json();
            if (data.result === "success") {
                resBox.innerHTML = `${Number(amt).toLocaleString()} ${from} = <br><span style="font-size: 1.6rem; color: #007bff;">${data.conversion_result.toLocaleString(undefined, {maximumFractionDigits: 2})} ${to}</span>`;
            }
        } catch (e) { resBox.innerText = i18n[currentLang].err_api; }
    }

    function renderClocks() {
        const list = document.getElementById('clockList');
        list.innerHTML = "";
        pinnedCities.forEach(tz => {
            const l = locations.find(item => item.tz === tz);
            if(!l) return;
            const div = document.createElement('div');
            div.className = 'clock-card';
            div.innerHTML = `<button class="remove-btn" onclick="removeClock('${tz}')">√ó</button><div class="clock-city">${currentLang === 'ja' ? l.city : l.cityEn}</div><div class="clock-time" id="time-${tz.replace(/\//g, '-')}">--:--:--</div>`;
            list.appendChild(div);
        });
    }

    function updateClocks() {
        pinnedCities.forEach(tz => {
            const el = document.getElementById(`time-${tz.replace(/\//g, '-')}`);
            if (el) {
                el.textContent = new Intl.DateTimeFormat(currentLang === 'ja' ? 'ja-JP' : 'en-US', { timeZone: tz, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).format(new Date());
            }
        });
    }

    function showTab(id) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + (id==='currency'?'curr':'time')).classList.add('active');
        document.getElementById(id).classList.add('active');
    }

    function addClock() {
        const tz = document.getElementById('timeSelect').value;
        if (tz && !pinnedCities.includes(tz)) { pinnedCities.push(tz); renderClocks(); }
    }

    function removeClock(tz) { pinnedCities = pinnedCities.filter(t => t !== tz); renderClocks(); }
    window.onload = init;
</script>
</body>
</html>
